<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEOS - Enterprise Health Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #ffffff; --text: #000000; --accent: #f0b90b; --gray: #f5f5f5; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        
        header { background: #000; color: #fff; padding: 40px 20px; text-align: center; position: relative; }
        .logo { font-size: 32px; font-weight: 800; letter-spacing: 2px; }
        
        .lang-toggle { position: absolute; top: 20px; right: 20px; background: #fff; border-radius: 20px; padding: 2px; display: flex; cursor: pointer; border: 1px solid #000; z-index: 100; }
        .lang-opt { padding: 4px 12px; border-radius: 18px; font-size: 11px; font-weight: bold; color: #000; }
        .active-lang { background: #000; color: #fff; }

        .main-content { max-width: 850px; margin: -30px auto 40px; background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; gap: 30px; position: relative; }
        
        .input-section { flex: 1; min-width: 320px; }
        .output-section { flex: 1; min-width: 320px; border-left: 1px solid #eee; padding-left: 20px; position: relative; min-height: 450px; }
        
        .section { margin-bottom: 25px; }
        h3 { font-size: 18px; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; }
        
        label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 13px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; margin-bottom: 12px; }
        
        button#diag-btn { width: 100%; padding: 15px; background: #000; color: #fff; border: none; border-radius: 6px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button#diag-btn:disabled { background: #666; cursor: not-allowed; }

        /* Loading 动画 */
        #loading-area { display: none; text-align: center; padding-top: 80px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 支付遮罩层 */
        #pay-gate { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.96); backdrop-filter: blur(12px); z-index: 50; text-align: center; flex-direction: column; justify-content: center; align-items: center; border-radius: 12px; padding: 20px; box-sizing: border-box; }
        .pay-card { background: #000; color: #fff; padding: 30px; border-radius: 15px; width: 100%; max-width: 300px; }
        .pay-btn { display: block; background: var(--accent); color: #000; padding: 15px; text-decoration: none; border-radius: 8px; font-weight: 900; margin-top: 20px; font-size: 16px; }

        /* 结果区域 */
        #result-area { display: none; transition: 0.5s; }
        .locked { opacity: 0.15; filter: blur(4px); pointer-events: none; }
        .score-box { text-align: center; margin-bottom: 20px; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .score-num { font-size: 48px; font-weight: 900; }
        .feedback { font-size: 14px; line-height: 1.6; padding: 15px; border-radius: 6px; }

        .danger { background: #fff5f5; color: #c53030; border-color: #feb2b2; }
        .warning { background: #fffaf0; color: #dd6b20; border-color: #fbd38d; }
        .success { background: #f0fff4; color: #2f855a; border-color: #9ae6b4; }
    </style>
</head>
<body>

<header>
    <div class="lang-toggle" onclick="toggleLang()">
        <div id="lang-zh" class="lang-opt active-lang">中文</div>
        <div id="lang-en" class="lang-opt">EN</div>
    </div>
    <div class="logo">PEOS</div>
</header>

<div class="main-content">
    <div class="input-section">
        <div class="section">
            <h3 id="ui-h1">1. 财务维度</h3>
            <label id="ui-l-cash">账面现金额 (元)</label>
            <input type="number" id="cash">
            <label id="ui-l-fixed">月均固定开支</label>
            <input type="number" id="fixed_costs">
            <label id="ui-l-profit">平均月利润</label>
            <input type="number" id="profit">
        </div>
        <div class="section">
            <h3 id="ui-h2">2. 行为维度</h3>
            <label id="ui-l-mixing">个人资金垫付次数</label>
            <input type="number" id="mixing">
        </div>
        <div class="section">
            <h3 id="ui-h3">3. 管理维度</h3>
            <label id="ui-l-inv">存货周转天数</label>
            <input type="number" id="inv_days">
            <label id="ui-l-ret">回头客比例 (0-100)</label>
            <input type="number" id="retention">
        </div>
        <button id="diag-btn" onclick="startAnalysis()">立即执行深度诊断</button>
    </div>

    <div class="output-section">
        <div id="loading-area">
            <div class="spinner"></div>
            <p id="ui-loading">深度算力建模中...</p>
        </div>

        <div id="pay-gate">
            <div class="pay-card">
                <h2 id="ui-pay-title">报告已生成</h2>
                <p id="ui-pay-desc" style="font-size: 13px;">需解锁以查看完整改进方案</p>
                <div style="font-size: 32px; font-weight: 900; color: var(--accent);">$39.9</div>
                <a href="https://nowpayments.io/payment/?iid=5636651544&paymentId=5203453273" class="pay-btn" id="ui-pay-btn" onclick="saveProgress()">立即解锁报告</a>
            </div>
        </div>

        <div id="result-area" class="locked">
            <div id="score-box" class="score-box">
                <div style="font-size: 12px;" id="ui-score-label">HEALTH SCORE</div>
                <div class="score-num" id="scoreValue">0</div>
                <div class="feedback" id="feedback"></div>
            </div>
            <canvas id="healthChart"></canvas>
        </div>
    </div>
</div>

<script>
    let currentLang = 'zh';
    let healthChart;

    const i18n = {
        zh: {
            h1: "1. 财务维度", h2: "2. 行为维度", h3: "3. 管理维度",
            l_cash: "账面现金额 (元)", l_fixed: "月均固定开支", l_profit: "平均月利润",
            l_mixing: "个人资金垫付次数", l_inv: "存货周转天数", l_ret: "回头客比例",
            ph_cash: "当前可用现金", ph_fixed: "月租金/工资等", ph_profit: "平均净利润",
            ph_mixing: "公私不分频率", ph_inv: "积压天数", ph_ret: "老客百分比",
            btn: "立即执行深度诊断", btn_running: "分析中...",
            loading: "正在接入 PEOS 核心算力进行建模...",
            pay_title: "诊断报告已生成", pay_desc: "查看完整财务模型及改进建议：",
            pay_btn: "立即解锁完整报告", score_label: "健康总分",
            chart_labels: ['财务', '行为', '管理'],
            danger: "<b>结果：高危。</b> 现金流断裂风险大。建议：立即停止个人垫资，撤销亏损业务。",
            warning: "<b>结果：亚健康。</b> 效率存在瓶颈。建议：优化周转，建立财务隔离。",
            success: "<b>结果：健康。</b> 逻辑清晰，抗风险强。建议：标准化并小规模复制。"
        },
        en: {
            h1: "1. Finance", h2: "2. Behavior", h3: "3. Operating",
            l_cash: "Cash Balance", l_fixed: "Fixed Costs", l_profit: "Net Profit",
            l_mixing: "Injections", l_inv: "Inv. Days", l_ret: "Retention %",
            ph_cash: "Liquid assets", ph_fixed: "Monthly burn", ph_profit: "Avg profit",
            ph_mixing: "Mixing frequency", ph_inv: "Inventory cycle", ph_ret: "Return rate",
            btn: "RUN DIAGNOSIS", btn_running: "Analyzing...",
            loading: "Connecting to PEOS Core Engine...",
            pay_title: "Report Ready", pay_desc: "Unlock to see full action plan:",
            pay_btn: "UNLOCK REPORT ($39.9)", score_label: "TOTAL SCORE",
            chart_labels: ['Finance', 'Behavior', 'Operating'],
            danger: "<b>CRITICAL.</b> High risk of failure. Action: Stop injections, cut losses.",
            warning: "<b>SUB-HEALTHY.</b> Efficiency issues. Action: Improve turnover.",
            success: "<b>HEALTHY.</b> Strong resilience. Action: Standardize & Scale."
        }
    };

    // 关键：支付跳转前保存数据
    function saveProgress() {
        const data = {
            cash: document.getElementById('cash').value,
            fixed: document.getElementById('fixed_costs').value,
            profit: document.getElementById('profit').value,
            mixing: document.getElementById('mixing').value,
            inv_days: document.getElementById('inv_days').value,
            retention: document.getElementById('retention').value
        };
        localStorage.setItem('peos_data', JSON.stringify(data));
    }

    function startAnalysis() {
        const btn = document.getElementById('diag-btn');
        btn.disabled = true;
        btn.innerText = i18n[currentLang].btn_running;
        
        document.getElementById('loading-area').style.display = 'block';
        document.getElementById('result-area').style.display = 'none';
        document.getElementById('pay-gate').style.display = 'none';

        setTimeout(() => {
            document.getElementById('loading-area').style.display = 'none';
            diagnose();
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('pay-gate').style.display = 'flex';
            btn.disabled = false;
            btn.innerText = i18n[currentLang].btn;
        }, 3000);
    }

    function diagnose() {
        const cash = parseFloat(document.getElementById('cash').value) || 0;
        const fixed = parseFloat(document.getElementById('fixed_costs').value) || 1;
        const mixing = parseInt(document.getElementById('mixing').value) || 0;
        const invDays = parseInt(document.getElementById('inv_days').value) || 0;
        const retention = parseInt(document.getElementById('retention').value) || 0;

        let fScore = Math.min((cash / fixed) / 6, 1) * 40;
        let bScore = Math.max(0, 30 - (mixing * 10));
        let mScore = ((retention / 100) * 15) + Math.max(0, 15 - (Math.max(0, invDays - 30) * 0.5));
        const totalScore = fScore + bScore + mScore;

        document.getElementById('scoreValue').innerText = totalScore.toFixed(1);
        const fb = document.getElementById('feedback');
        const box = document.getElementById('score-box');
        const t = i18n[currentLang];

        box.className = 'score-box';
        if (totalScore < 45) { box.classList.add('danger'); fb.innerHTML = t.danger; }
        else if (totalScore < 75) { box.classList.add('warning'); fb.innerHTML = t.warning; }
        else { box.classList.add('success'); fb.innerHTML = t.success; }

        updateChart([fScore, bScore, mScore]);
    }

    // 关键：页面加载时检测支付状态
    window.onload = function() {
        updateUI();
        const params = new URLSearchParams(window.location.search);
        
        if (params.get('pay') === 'success') {
            const saved = JSON.parse(localStorage.getItem('peos_data'));
            if (saved) {
                document.getElementById('cash').value = saved.cash;
                document.getElementById('fixed_costs').value = saved.fixed;
                document.getElementById('profit').value = saved.profit;
                document.getElementById('mixing').value = saved.mixing;
                document.getElementById('inv_days').value = saved.inv_days;
                document.getElementById('retention').value = saved.retention;
                
                diagnose();
                // 永久解锁
                document.getElementById('result-area').style.display = 'block';
                document.getElementById('result-area').classList.remove('locked');
                document.getElementById('pay-gate').style.display = 'none';
                document.getElementById('diag-btn').style.display = 'none';
            }
        }
    };

    function toggleLang() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        document.getElementById('lang-zh').classList.toggle('active-lang');
        document.getElementById('lang-en').classList.toggle('active-lang');
        updateUI();
    }

    function updateUI() {
        const t = i18n[currentLang];
        document.getElementById('ui-h1').innerText = t.h1;
        document.getElementById('ui-h2').innerText = t.h2;
        document.getElementById('ui-h3').innerText = t.h3;
        document.getElementById('ui-l-cash').innerText = t.l_cash;
        document.getElementById('ui-l-fixed').innerText = t.l_fixed;
        document.getElementById('ui-l-profit').innerText = t.l_profit;
        document.getElementById('ui-l-mixing').innerText = t.l_mixing;
        document.getElementById('ui-l-inv').innerText = t.l_inv;
        document.getElementById('ui-l-ret').innerText = t.l_ret;
        document.getElementById('diag-btn').innerText = t.btn;
        document.getElementById('ui-loading').innerText = t.loading;
        document.getElementById('ui-pay-title').innerText = t.pay_title;
        document.getElementById('ui-pay-desc').innerText = t.pay_desc;
        document.getElementById('ui-pay-btn').innerText = t.pay_btn;
        document.getElementById('ui-score-label').innerText = t.score_label;
        
        document.getElementById('cash').placeholder = t.ph_cash;
        document.getElementById('fixed_costs').placeholder = t.ph_fixed;
        document.getElementById('profit').placeholder = t.ph_profit;
        document.getElementById('mixing').placeholder = t.ph_mixing;
        document.getElementById('inv_days').placeholder = t.ph_inv;
        document.getElementById('retention').placeholder = t.ph_ret;
    }

    function updateChart(scores) {
        const ctx = document.getElementById('healthChart').getContext('2d');
        if (healthChart) {
            healthChart.data.datasets[0].data = scores;
            healthChart.update();
        } else {
            healthChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: i18n[currentLang].chart_labels, datasets: [{ data: scores, backgroundColor: ['#000', '#666', '#999'] }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 40 } } }
            });
        }
    }
</script>

</body>
</html>
